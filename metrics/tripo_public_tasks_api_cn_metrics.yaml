version: 1
type: metrics_view

display_name: 公有任务API（中国区）指标
model: tripo_public_tasks_api_cn_m
timeseries: create_time

dimensions:
  - name: 任务ID
    display_name: 任务ID
    column: task_id

  - name: 客户ID
    display_name: 客户ID
    column: client_id

  - name: 任务类型
    display_name: 任务类型
    column: type

  - name: 任务状态
    display_name: 任务状态
    column: status

  - name: 是否删除
    display_name: 是否删除
    column: is_delete

  - name: 输入模型版本
    display_name: 输入模型版本
    column: input_model_version

  - name: 输入文件类型
    display_name: 输入文件类型
    column: input_file_type

  - name: 输入文件桶
    display_name: 输入文件桶
    column: input_file_bucket

  - name: 贴图质量
    display_name: 贴图质量
    column: input_texture_quality

  - name: 几何质量
    display_name: 几何质量
    column: input_geometry_quality

  - name: 启用PBR
    display_name: 启用PBR
    column: input_pbr

  - name: 生成贴图
    display_name: 生成贴图
    column: input_texture

  - name: 保留四边面
    display_name: 保留四边面
    column: input_quad

  - name: 智能低模
    display_name: 智能低模
    column: input_smart_low_poly

  - name: 创建时间
    display_name: 创建时间
    column: create_time

  - name: 启动时间
    display_name: 启动时间
    column: start_time

  - name: 结束时间
    display_name: 结束时间
    column: end_time

  - name: 更新时间
    display_name: 更新时间
    column: update_time

  - name: 交易ID
    display_name: 交易ID
    column: txn_id

  - name: 处理时长秒
    display_name: 处理时长（秒）
    column: duration_seconds
  - column: reason
    name: reason
    display_name: 失败原因

measures:
  # ===== 任务规模 =====
  - name: 总任务数
    display_name: 总任务数
    expression: COUNT(*)
    format_preset: humanize

  - name: 客户数
    display_name: 客户数
    expression: COUNT(DISTINCT client_id)
    format_preset: humanize

  - name: 任务类型数
    display_name: 任务类型数
    expression: COUNT(DISTINCT type)
    format_preset: humanize

  - name: 输入模型版本数
    display_name: 输入模型版本数
    expression: COUNT(DISTINCT input_model_version)
    format_preset: humanize

  - name: 删除任务数
    display_name: 删除任务数
    expression: SUM(CASE WHEN is_delete THEN 1 ELSE 0 END)
    format_preset: humanize

  # ===== 任务状态 =====
  - name: 成功任务数
    display_name: 成功任务数
    expression: SUM(CASE WHEN LOWER(status) IN ('success', 'succeeded', 'finished',
      'done') THEN 1 ELSE 0 END)
    format_preset: humanize

  - name: 失败任务数
    display_name: 失败任务数
    expression: SUM(CASE WHEN LOWER(status) IN ('failed', 'error', 'expired',
      'cancelled', 'canceled') THEN 1 ELSE 0 END)
    format_preset: humanize

  - name: 进行中任务数
    display_name: 进行中任务数
    expression: SUM(CASE WHEN LOWER(status) IN ('running', 'processing', 'queued')
      THEN 1 ELSE 0 END)
    format_preset: humanize

  - name: 成功率
    display_name: 成功率
    expression: SUM(CASE WHEN LOWER(status) IN ('success', 'succeeded', 'finished',
      'done') THEN 1 ELSE 0 END) * 1.0 / NULLIF(COUNT(*), 0)
    format_preset: percentage

  - name: 失败率
    display_name: 失败率
    expression: SUM(CASE WHEN LOWER(status) IN ('failed', 'error', 'expired',
      'cancelled', 'canceled') THEN 1 ELSE 0 END) * 1.0 / NULLIF(COUNT(*), 0)
    format_preset: percentage

  # ===== 时长指标 =====
  - name: 有时长任务数
    display_name: 有时长任务数
    expression: COUNT(CASE WHEN duration_seconds IS NOT NULL THEN 1 END)
    format_preset: humanize

  - name: 平均处理时长
    display_name: 平均处理时长（秒）
    expression: AVG(duration_seconds)
    format_preset: humanize

  - name: 最大处理时长
    display_name: 最大处理时长（秒）
    expression: MAX(duration_seconds)
    format_preset: humanize

  - name: 最小处理时长
    display_name: 最小处理时长（秒）
    expression: MIN(duration_seconds)
    format_preset: humanize

  - name: P95处理时长
    display_name: P95处理时长（秒）
    expression: QUANTILE_CONT(duration_seconds, 0.95)
    format_preset: humanize

  # ===== 参数使用情况 =====
  - name: 启用PBR任务数
    display_name: 启用PBR任务数
    expression: SUM(CASE WHEN input_pbr THEN 1 ELSE 0 END)
    format_preset: humanize

  - name: 生成贴图任务数
    display_name: 生成贴图任务数
    expression: SUM(CASE WHEN input_texture THEN 1 ELSE 0 END)
    format_preset: humanize

  - name: 保留四边面任务数
    display_name: 保留四边面任务数
    expression: SUM(CASE WHEN input_quad THEN 1 ELSE 0 END)
    format_preset: humanize

  - name: 智能低模任务数
    display_name: 智能低模任务数
    expression: SUM(CASE WHEN input_smart_low_poly THEN 1 ELSE 0 END)
    format_preset: humanize

  - name: 高贴图质量任务数
    display_name: 高贴图质量任务数
    expression: SUM(CASE WHEN LOWER(input_texture_quality) IN ('detailed', 'high')
      THEN 1 ELSE 0 END)
    format_preset: humanize

  - name: 高几何质量任务数
    display_name: 高几何质量任务数
    expression: SUM(CASE WHEN LOWER(input_geometry_quality) IN ('detailed', 'high')
      THEN 1 ELSE 0 END)
    format_preset: humanize

  - name: 图片输入任务数
    display_name: 图片输入任务数
    expression: SUM(CASE WHEN LOWER(input_file_type) IN ('png', 'jpg', 'jpeg',
      'webp') THEN 1 ELSE 0 END)
    format_preset: humanize

  - name: v30版本任务数
    display_name: v3.0版本任务数
    expression: SUM(CASE WHEN input_model_version LIKE 'v3.0%' THEN 1 ELSE 0 END)
    format_preset: humanize

  - name: 交易关联任务数
    display_name: 交易关联任务数
    expression: COUNT(DISTINCT CASE WHEN txn_id IS NOT NULL THEN task_id END)
    format_preset: humanize

  - name: 交易关联率
    display_name: 交易关联率
    expression: COUNT(DISTINCT CASE WHEN txn_id IS NOT NULL THEN task_id END) * 1.0
      / NULLIF(COUNT(DISTINCT task_id), 0)
    format_preset: percentage
