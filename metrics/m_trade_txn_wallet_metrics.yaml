version: 1
type: metrics_view

display_name: Transaction Wallet Metrics
model: m_trade_txn_wallet
timeseries: settle_time

dimensions:
  - name: txn_id
    display_name: Transaction ID
    column: txn_id

  - name: wallet_id
    display_name: Wallet ID
    column: wallet_id

  - name: wallet_type
    display_name: Wallet Type
    column: wallet_type

  - name: wallet_sub_type
    display_name: Wallet Sub Type
    column: wallet_sub_type

  - name: direction
    display_name: Direction
    column: direction

  - name: type
    display_name: Type
    column: type

  - name: status
    display_name: Status
    column: status

  - name: email
    display_name: Email
    column: email

  - name: domain
    display_name: Domain
    column: "domain"

  - name: pt
    display_name: PT
    column: pt
  - column: create_time
    name: create_time

measures:
  - name: total_transactions
    display_name: 总交易数
    expression: COUNT(*)
    format_preset: humanize

  - name: total_wallets
    display_name: 钱包数
    expression: COUNT(DISTINCT wallet_id)
    format_preset: humanize

  - name: total_emails
    display_name: 邮箱数
    expression: COUNT(DISTINCT email)
    format_preset: humanize

  - name: total_domains
    display_name: 域名数
    expression: COUNT(DISTINCT "domain")
    format_preset: humanize

  - name: total_amount
    display_name: 总交易点数
    expression: SUM(amount)
    format_preset: currency

  - name: avg_amount
    display_name: 平均交易点数
    expression: AVG(amount)
    format_preset: currency

  - name: completed_transactions
    display_name: 完成交易数
    expression: SUM(CASE WHEN status = '完成' THEN 1 ELSE 0 END)
    format_preset: humanize

  - name: failed_transactions
    display_name: 失败交易数
    expression: SUM(CASE WHEN status in ('失败', '取消','过期') THEN 1 ELSE 0 END)
    format_preset: humanize

  # API充值钱包 - 消费金额
  - name: api_wallet_consumption_amount
    display_name: API充值钱包消费点数
    expression: SUM(CASE WHEN wallet_sub_type = 'API充值钱包' AND type = '消费' AND status
      = '完成' THEN amount ELSE 0 END)
    format_preset: currency

  # API充值钱包 - 充值金额
  - name: api_wallet_recharge_amount
    display_name: API充值钱包充值点数
    expression: SUM(CASE WHEN wallet_sub_type = 'API充值钱包' AND type = '充值' AND status
      = '完成' THEN amount ELSE 0 END)
    format_preset: currency

  # WEB免费钱包 - 消费金额
  - name: web_free_wallet_consumption_amount
    display_name: WEB免费钱包消费点数
    expression: SUM(CASE WHEN wallet_sub_type = 'WEB免费钱包' AND type = '消费' AND status
      = '完成' THEN amount ELSE 0 END)
    format_preset: currency

  # WEB免费钱包 - 充值金额
  - name: web_free_wallet_recharge_amount
    display_name: WEB免费钱包充值点数
    expression: SUM(CASE WHEN wallet_sub_type = 'WEB免费钱包' AND type = '充值' AND status
      = '完成' THEN amount ELSE 0 END)
    format_preset: currency

  # WEB订阅钱包 - 消费金额
  - name: web_subscription_wallet_consumption_amount
    display_name: WEB订阅钱包消费点数
    expression: SUM(CASE WHEN wallet_sub_type = 'WEB订阅钱包' AND type = '消费' AND status
      = '完成' THEN amount ELSE 0 END)
    format_preset: currency

  # WEB订阅钱包 - 充值金额
  - name: web_subscription_wallet_recharge_amount
    display_name: WEB订阅钱包充值点数
    expression: SUM(CASE WHEN wallet_sub_type = 'WEB订阅钱包' AND type = '充值' AND status
      = '完成' THEN amount ELSE 0 END)
    format_preset: currency
